<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Focus Mode Button Settings</title>
    <link rel="stylesheet" href="inspector.css">
</head>
<body>
    <div class="sdpi-wrapper">
        <div class="sdpi-item">
            <div class="sdpi-item-label">IP Address / Hostname</div>
            <input class="sdpi-item-value" id="ipAddress" type="text" placeholder="192.168.1.100 or phone.local">
        </div>
        
        <div class="sdpi-item">
            <div class="sdpi-item-label">Port</div>
            <input class="sdpi-item-value" id="port" type="number" value="4747" min="1" max="65535">
        </div>
        
        <div class="sdpi-item">
            <div class="sdpi-item-label">Focus Mode</div>
            <select class="sdpi-item-value" id="targetMode">
                <option value="0">Normal</option>
                <option value="1">Macro</option>
                <option value="2">Continuous</option>
                <option value="3">Infinity</option>
            </select>
        </div>
        
        <div class="sdpi-item" style="align-items: center;">
            <button id="test-connection" style="flex: 0 0 auto; margin-right: 8px; align-self: center;">Test Connection</button>
            <span id="test-result" style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 9pt; line-height: 1; vertical-align: middle;"></span>
        </div>
        
        <div class="sdpi-item">
            <div class="sdpi-item-child" style="margin-top: 8px; font-size: 11px; color: #999;">
                <strong>Focus Modes:</strong><br>
                • Normal - Standard autofocus<br>
                • Macro - Close-up focus<br>
                • Continuous - Tracks moving subjects<br>
                • Infinity - Fixed focus at infinity
            </div>
        </div>
    </div>

    <script>
        let websocket = null;
        let uuid = null;
        let actionInfo = null;
        
        // Property Inspector接続
        window.connectElgatoStreamDeckSocket = (inPort, inPropertyInspectorUUID, inRegisterEvent, inInfo, inActionInfo) => {
            uuid = inPropertyInspectorUUID;
            const actionInfo = JSON.parse(inActionInfo);
            
            // WebSocket接続
            websocket = new WebSocket(`ws://localhost:${inPort}`);
            
            websocket.onopen = () => {
                console.log('Property Inspector connected');
                
                // 登録
                const json = {
                    event: inRegisterEvent,
                    uuid: uuid
                };
                websocket.send(JSON.stringify(json));
                
                // 設定を取得
                const getSettings = {
                    event: 'getSettings',
                    context: uuid
                };
                websocket.send(JSON.stringify(getSettings));
            };
            
            websocket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log('Received:', message);
                
                if (message.event === 'didReceiveSettings') {
                    const settings = message.payload.settings;
                    
                    document.getElementById('ipAddress').value = settings.ipAddress || '';
                    document.getElementById('port').value = settings.port || 4747;
                    document.getElementById('targetMode').value = settings.targetMode !== undefined ? settings.targetMode : 0;
                }
            };
            
            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        };
        
        // 設定を保存
        function saveSettings() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                console.log('WebSocket not ready');
                return;
            }
            
            const settings = {
                ipAddress: document.getElementById('ipAddress').value,
                port: parseInt(document.getElementById('port').value) || 4747,
                targetMode: parseInt(document.getElementById('targetMode').value) || 0
            };
            
            console.log('Saving settings:', settings);
            
            const json = {
                event: 'setSettings',
                context: uuid,
                payload: settings
            };
            websocket.send(JSON.stringify(json));
        }

        // 入力ハンドラー（少し遅延を入れて保存）
        let saveTimeout = null;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveSettings, 500);
        }
        
        document.getElementById('ipAddress').addEventListener('input', debouncedSave);
        document.getElementById('port').addEventListener('input', debouncedSave);
        document.getElementById('targetMode').addEventListener('change', debouncedSave);
        
        // 接続テスト
        document.getElementById('test-connection').addEventListener('click', async () => {
            const ipAddress = document.getElementById('ipAddress').value;
            const port = document.getElementById('port').value;
            const resultDiv = document.getElementById('test-result');
            
            if (!ipAddress) {
                resultDiv.textContent = 'Please enter an IP address or hostname';
                resultDiv.style.backgroundColor = '#dc3545';
                resultDiv.style.color = '#ffffff';
                return;
            }
            
            resultDiv.textContent = 'Testing connection...';
            resultDiv.style.backgroundColor = '#17a2b8';
            resultDiv.style.color = '#ffffff';
            
            try {
                // DroidCamの端末名を取得してテスト
                const response = await fetch(`http://${ipAddress}:${port}/v1/phone/name`);
                
                if (response.ok) {
                    const deviceName = await response.text();
                    resultDiv.textContent = `Connected to: ${deviceName}`;
                    resultDiv.style.backgroundColor = '#28a745';
                    resultDiv.style.color = '#ffffff';
                    
                    // プラグインに接続成功を通知
                    if (websocket && websocket.readyState === WebSocket.OPEN) {
                        const notification = {
                            event: 'sendToPlugin',
                            action: actionInfo?.action,
                            context: uuid,
                            payload: {
                                action: 'testConnection',
                                success: true,
                                deviceName: deviceName
                            }
                        };
                        websocket.send(JSON.stringify(notification));
                    }
                    
                    // 設定を保存
                    saveSettings();
                } else {
                    resultDiv.textContent = `Connection failed: ${response.status}`;
                    resultDiv.style.backgroundColor = '#dc3545';
                    resultDiv.style.color = '#ffffff';
                }
            } catch (error) {
                resultDiv.textContent = `Connection error: ${error.message}`;
                resultDiv.style.backgroundColor = '#dc3545';
                resultDiv.style.color = '#ffffff';
            }
        });
    </script>
</body>
</html>