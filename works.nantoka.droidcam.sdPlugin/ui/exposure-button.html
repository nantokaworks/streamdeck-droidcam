<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>露出ボタン設定</title>
    <link rel="stylesheet" href="inspector.css">
</head>
<body>
    <div class="sdpi-wrapper">
        <div class="sdpi-item">
            <div class="sdpi-item-label">IPアドレス / ホスト名</div>
            <input class="sdpi-item-value" id="ipAddress" type="text" placeholder="192.168.1.100 または phone.local">
        </div>
        
        <div class="sdpi-item">
            <div class="sdpi-item-label">ポート</div>
            <input class="sdpi-item-value" id="port" type="number" value="4747" min="1" max="65535">
        </div>
        
        <div class="sdpi-item">
            <div class="sdpi-item-label">感度</div>
            <input class="sdpi-item-value" id="sensitivity" type="number" value="0.5" min="-2.0" max="2.0" step="0.1">
            <div class="sdpi-item-child" style="margin-top: 4px; font-size: 11px; color: #999;">
                正の値で露出を明るく、負の値で露出を暗く
            </div>
        </div>
        
        <div class="sdpi-item" style="align-items: center;">
            <button id="test-connection" style="flex: 0 0 auto; margin-right: 8px; align-self: center;">接続テスト</button>
            <span id="test-result" style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 9pt; line-height: 1; vertical-align: middle;"></span>
        </div>
    </div>

    <script>
        let websocket = null;
        let uuid = null;
        let actionInfo = null;
        
        // Property Inspector接続
        window.connectElgatoStreamDeckSocket = (inPort, inPropertyInspectorUUID, inRegisterEvent, inInfo, inActionInfo) => {
            uuid = inPropertyInspectorUUID;
            const actionInfo = JSON.parse(inActionInfo);
            
            // WebSocket接続
            websocket = new WebSocket(`ws://localhost:${inPort}`);
            
            websocket.onopen = () => {
                console.log('Property Inspector connected');
                
                // 登録
                const json = {
                    event: inRegisterEvent,
                    uuid: uuid
                };
                websocket.send(JSON.stringify(json));
                
                // 設定を取得
                const getSettings = {
                    event: 'getSettings',
                    context: uuid
                };
                websocket.send(JSON.stringify(getSettings));
            };
            
            websocket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log('Received:', message);
                
                if (message.event === 'didReceiveSettings') {
                    const settings = message.payload.settings;
                    
                    document.getElementById('ipAddress').value = settings.ipAddress || '';
                    document.getElementById('port').value = settings.port || 4747;
                    document.getElementById('sensitivity').value = settings.sensitivity ?? 0.5;
                }
            };
            
            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        };
        
        // 設定を保存
        function saveSettings() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                console.log('WebSocket not ready');
                return;
            }
            
            const settings = {
                ipAddress: document.getElementById('ipAddress').value,
                port: parseInt(document.getElementById('port').value) || 4747,
                sensitivity: parseFloat(document.getElementById('sensitivity').value) || 0.5
            };
            
            console.log('Saving settings:', settings);
            
            const json = {
                event: 'setSettings',
                context: uuid,
                payload: settings
            };
            websocket.send(JSON.stringify(json));
        }

        // 入力ハンドラー（少し遅延を入れて保存）
        let saveTimeout = null;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveSettings, 500);
        }
        
        document.getElementById('ipAddress').addEventListener('input', debouncedSave);
        document.getElementById('port').addEventListener('input', debouncedSave);
        document.getElementById('sensitivity').addEventListener('input', debouncedSave);
        
        // 接続テスト
        document.getElementById('test-connection').addEventListener('click', async () => {
            const ipAddress = document.getElementById('ipAddress').value;
            const port = document.getElementById('port').value;
            const resultDiv = document.getElementById('test-result');
            
            if (!ipAddress) {
                resultDiv.textContent = 'IPアドレスまたはホスト名を入力してください';
                resultDiv.style.backgroundColor = '#dc3545';
                resultDiv.style.color = '#ffffff';
                return;
            }
            
            resultDiv.textContent = '接続をテスト中...';
            resultDiv.style.backgroundColor = '#17a2b8';
            resultDiv.style.color = '#ffffff';
            
            try {
                // DroidCamの端末名を取得してテスト
                const response = await fetch(`http://${ipAddress}:${port}/v1/phone/name`);
                
                if (response.ok) {
                    const deviceName = await response.text();
                    resultDiv.textContent = `接続成功: ${deviceName}`;
                    resultDiv.style.backgroundColor = '#28a745';
                    resultDiv.style.color = '#ffffff';
                    
                    // 設定を保存
                    saveSettings();
                } else {
                    resultDiv.textContent = `接続失敗: ${response.status}`;
                    resultDiv.style.backgroundColor = '#dc3545';
                    resultDiv.style.color = '#ffffff';
                }
            } catch (error) {
                resultDiv.textContent = `接続エラー: ${error.message}`;
                resultDiv.style.backgroundColor = '#dc3545';
                resultDiv.style.color = '#ffffff';
            }
        });
    </script>
</body>
</html>