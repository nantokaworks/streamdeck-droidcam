<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Zoom Button Settings</title>
    <link rel="stylesheet" href="inspector.css">
    <script src="i18n.js"></script>
    <script src="pi-common.js"></script>
    <script src="pi-components.js"></script>
</head>
<body>
    <div class="sdpi-wrapper" id="content">
        <!-- Content will be generated by JavaScript -->
    </div>

    <script>
        // Initialize Property Inspector
        const pi = new PICommon.PropertyInspector({ debug: false });
        
        // Initialize UI when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize i18n
            PIComponents.PIComponents.initializeI18n();
            
            // Get content container
            const content = document.getElementById('content');
            
            // Add connection settings
            content.appendChild(
                PIComponents.PIComponents.createConnectionSettings()
            );
            
            // Add sensitivity field
            const sensitivityField = PIComponents.PIComponents.createField({
                label: 'Sensitivity',
                type: 'number',
                id: 'sensitivity',
                value: '0.5',
                min: -2.0,
                max: 2.0,
                step: 0.1,
                dataSetting: 'sensitivity',
                i18nLabel: 'settings.sensitivity',
                placeholder: '0.5',
                help: 'Positive values for zoom in, negative for zoom out',
                i18nHelp: 'help.zoom-positive'
            });
            content.appendChild(sensitivityField);
            
            // Add test connection button using common function
            content.appendChild(
                PIComponents.PIComponents.createTestConnectionButton(async () => {
                    const ipAddress = document.getElementById('ipAddress').value;
                    const port = document.getElementById('port').value;
                    
                    if (!ipAddress) {
                        return {
                            success: false,
                            error: i18n.t('message.enter-ip', 'Please enter IP address or hostname')
                        };
                    }
                    
                    // Use common test connection function
                    const result = await pi.testConnection(ipAddress, parseInt(port));
                    
                    // Save settings if successful
                    if (result.success) {
                        pi.saveSettings();
                        
                        // Send success to plugin (zoom-button specific)
                        if (pi.websocket && pi.websocket.readyState === WebSocket.OPEN) {
                            const payload = {
                                action: 'testConnection',
                                success: true,
                                deviceName: result.deviceName
                            };
                            pi.websocket.send(JSON.stringify({
                                event: 'sendToPlugin',
                                context: pi.uuid,
                                payload: payload
                            }));
                        }
                    }
                    
                    return result;
                })
            );
            
            // Bind all inputs to settings
            pi.bindAllInputs();
            
            // Load initial settings
            pi.onSettingsChange((settings) => {
                if (settings.ipAddress) {
                    document.getElementById('ipAddress').value = settings.ipAddress;
                }
                if (settings.port) {
                    document.getElementById('port').value = settings.port;
                }
                if (settings.sensitivity !== undefined) {
                    document.getElementById('sensitivity').value = settings.sensitivity;
                }
            });
            
            // Listen for messages from plugin (if needed for future features)
            pi.onMessageFromPlugin((payload) => {
                console.log('Received from plugin:', payload);
                // Handle any plugin messages if needed
            });
        });
        
        // Setup Stream Deck connection
        PICommon.setupPropertyInspector(pi);
    </script>
</body>
</html>